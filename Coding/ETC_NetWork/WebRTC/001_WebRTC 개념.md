## { WEB RTC란? }
- 정의 : WebRTC는 웹 브라우저 간에 플러그인의 도움 없이 서로 통신할 수 있도록 설계된 API이다. 음성 통화, 영상 통화, P2P 파일 공유 등으로 활용될 수 있다. 
- 필요성: 기존 방식대로 서버를 경유하여 통신하는 경우에는 클라이언트 수가 많을수록,데이터의 양을 많이 처리할수록 서버측에 가해지는 부담이 커지기 때문에 클라이언트끼리 통신하는 방법이 생겨나게 되었다. 
- 사용 : 주로 화상통화, 실시간 채팅등에 사용된다. 
---
**<용어 정리> 
- **p2p방식(peer to peer)**: 중앙 서버를 거치지 않고 개인 간(사용자 간)에 직접 데이터를 주고받는 방식. peer는 귀를 열고 있다는 뜻으로 생각하면 편하다. 서로 귀를 열어두고 있는 상태에서 _시그널을 보내_(시그널링)을 통해 데이터를 서로 전송이 가능하다. 
- 시그널링(signaling): 두 클라이언트가 무엇으로 대화할지, 그리고 어떻게 대화할지 합의하는 과정이다. 
- TCP: 느리지만 안정성있는 데이터 전송을 해야할 때 사용하는 프로토콜. (3way handshake는 여기서)
- UDP: 실시간으로 데이터 전송을 해야할 때 사용하는 프로토콜(p2p 방식은 여기서)

## { WEB RTC의동작원리(내부구조) }
![](https://velog.velcdn.com/images/rambus/post/c54fb1ed-7e35-4a3e-9915-87093f1dab48/image.png)

### 1. 데이터 패키징 방법 
  - SDP(Session Description Protocol) : '무엇으로 소통할지','어떻게 소통할지'를 적어 보내는 방식이다. 세션 정보,네트워크 관련 정보, 미디어의 유형과 스트림의 속성등이 어떻게 작성되는지 정해져있는 데이터를 처리한다. (택배 박스) 

### 2. 데이터 전송 과정
- 클라이언트들은 각각 소통에 사용할 수 있는 네트워크 경로들의 후보 정보를 보낸다.(Interactive Connectivity Establishment Candidate)(ICE 후보)

> ICE 후보 유형

**세개 다 응답을 받아서 최적의 경로를 찾아 사용한다. **
1. HOST Candidate(호스트 후보,자신의 사설 IP와 포트 넘버): 두 사용자가 한 집이나 오피스 등 같은 네트워크에 속한 경우에 사용된다. 각자의 IP 번호만 알면 연결 가능 
2. Server Reflexive Candidate(자신의 공인 IP와 포트 넘버 (STUN, TURN 서버로부터 획득 가능)):사용자들끼리 같은 네트워크에 속하지 않고 멀리 있는 경우에 사용된다. 
3. TURN 서버의 IP와 포트 넘버 (TURN 서버로부터 획득 가능)

> STUN 서버 

- 일반적으로 사용자의 클라이언트 기기는 NAT을 사용하여 네트워크에 연결되어있고, 공통으로 사용하는 IP가 있다. (라우터의 공인 IP)
- 클라이언트끼리 소통하기 위해서는 각자의 주소, 공통으로 사용하는 공인 IP 모두 알아야 한다. (가끔 바뀌기 때문에 사용자가 현재 사용하는 각자의 IP, 공인 라우터 IP 를 모두 알아야 한다.)
- 이 IP 주소를 알아내는 것이 STUN이다.
![](https://velog.velcdn.com/images/rambus/post/e774b41c-aa3d-4d1e-bd6d-bf676a1b3d77/image.png)
![](https://velog.velcdn.com/images/rambus/post/f961a29b-76e9-427a-9a1f-314932ad7068/image.png)
- webRTC로 구현되는 서비스에는 특정 STUN 서버가 지정되어있다. 
- 클라이언트는 STUN서버에게 요청을 보내고, STUN server는 클라이언트 응답으로 공인 IP 주소와 포트 번호를 알려준다. 
- STUN서버는 Google,Twilio,Xirsys,AWS,Coturn 등 많은 서비스 기업들에서 제공하고 있어 우리는 클라이언트로서 js 응답만 보내면 된다. 
- 클라이언트는 STUN 서버에서 받아온 응답을 두번째 후보로 등록해둔다. 
![](https://velog.velcdn.com/images/rambus/post/82735766-1ff2-4e5a-8261-8ded32c7896e/image.png)

> TURN 서버

- 네트워크 환경이 복잡하거나, 방화벽등에 의해 P2P 통신이 제한되어있는 등의 경우 STUN 서버요청이 어려워 사용이 불가한 경우가 있다. 이때 Turn 서버를 사용한다. 
- 경로를 추가해 우회하는 것이기 때문에 시간이 오래 걸린다. 
![](https://velog.velcdn.com/images/rambus/post/02ad9d6c-e7ee-4840-a7b2-7fef49b36052/image.png)

### 3. P2P 소통 프로토콜 
> P2P 통신 프로토콜의 종류 

- **SRTP** : 비디오나 오디오의 실시간 전송에 적합한 프로토콜. UDP 기반이다. 
- **SCTP** : 파일 전송 프로토콜. UDP 기반이지만 TCP처럼 안정성을 보장하는 프로토콜 

### { 결론 및 정리 }
- WebRTC 는 클라이언트-클라이언트 간 통신방식이다. 
- sdp를 통해 데이터 정보를 택배 박스처럼 담는다. 
- 클라이언트는 stun서버,turn 서버를 사용하여 후보 3개를 서버로부터 받는다. 후보 중 최적의 후보를 선택해 사용한다. 
- 데이터 전송을 할 때 사용하는 프로토콜은 (비디오나 오디오의 실시간 전송의 경우 UDP 기반 SRTP, 파일 전송의 경우 UDP 기반이지만 안정성을 보장하는 SCTP를 사용한다.) 
